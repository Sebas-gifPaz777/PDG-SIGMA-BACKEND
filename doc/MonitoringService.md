# Diseño de Pruebas: MonitoringController - Endpoints de Reportes (MonitoringControllerReportTest)

Este documento describe los casos de prueba implementados en la clase `MonitoringControllerReportTest` para verificar la funcionalidad de los diversos endpoints de generación de reportes dentro de `MonitoringController`.

**Objetivo:** Validar que el controlador maneja correctamente las solicitudes para los diferentes reportes (rendimiento de monitores, rendimiento del profesor, uso de categorías, asistencia mensual), interactúa adecuadamente con `MonitoringServiceImpl`, y gestiona los casos de éxito y diversos escenarios de error.

**Alcance:** Pruebas unitarias/de integración ligera de los endpoints de reporte (`/getMonitorsReport/{id}`, `/getProfessorReport/{id}`, `/getCategoriesReport/{id}`, `/getAttendanceReport/{id}`) utilizando `@WebMvcTest`. Se mockea la dependencia `MonitoringServiceImpl` para aislar la prueba al controlador.

**Estrategia:** Simular peticiones HTTP GET utilizando `MockMvc`. Configurar el mock de `MonitoringServiceImpl` para devolver los datos esperados (en los formatos correctos para cada reporte: `List<ReportDTO>`, `Map<String, Object>`, `List<Map<String, Object>>`) o lanzar excepciones según el escenario. Verificar los códigos de estado HTTP y el contenido de las respuestas JSON (`jsonPath` o `content().string()`).

## Casos de Prueba (Implementados en `MonitoringControllerReportTest`)

### 1. Reporte de Rendimiento de Monitores (`/getMonitorsReport/{idProfessor}`)

| ID Caso  | Nombre del Test (Método)           | Descripción                                                               | Precondiciones (Mocks)                                                      | Pasos                                                                                        | Resultado Esperado                                                                                                              | Estado    |
| :------- | :--------------------------------- | :------------------------------------------------------------------------ | :-------------------------------------------------------------------------- | :------------------------------------------------------------------------------------------- | :------------------------------------------------------------------------------------------------------------------------------ | :-------- |
| MON-RPT-001 | `getMonitorsReport_Success`        | Verifica la obtención exitosa del reporte de rendimiento de monitores.    | `monitoringService.getReportMonitors` devuelve `List<ReportDTO>` válida.      | 1. Definir `idProfessor`. 2. Configurar Mock. 3. Realizar petición GET.      | Status HTTP 200 (OK). Cuerpo JSON es un array con los datos del DTO esperados.                                                  | Comentado |
| MON-RPT-002 | `getMonitorsReport_ProfessorNotFound`| Verifica el manejo cuando el profesor no es encontrado por el servicio. | `monitoringService.getReportMonitors` lanza `Exception("No hay profesor...")`. | 1. Definir `idProfessor`. 2. Configurar Mock para lanzar excepción. 3. Realizar petición GET. | Status HTTP 500 (Internal Server Error). Cuerpo de la respuesta contiene el mensaje de error del servicio.                          | OK        |
| MON-RPT-003 | `getMonitorsReport_EmptyReport`    | Verifica el manejo cuando no hay reportes para mostrar (según excepción). | `monitoringService.getReportMonitors` lanza `Exception("No hay reportes...")`. | 1. Definir `idProfessor`. 2. Configurar Mock para lanzar excepción. 3. Realizar petición GET. | Status HTTP 500 (Internal Server Error). Cuerpo de la respuesta contiene el mensaje de error del servicio ("No hay reportes..."). | OK        |

---

### 2. Reporte de Rendimiento del Profesor (`/getProfessorReport/{idProfessor}`)

| ID Caso  | Nombre del Test (Método)          | Descripción                                                               | Precondiciones (Mocks)                                                         | Pasos                                                                                          | Resultado Esperado                                                                            | Estado    |
| :------- | :-------------------------------- | :------------------------------------------------------------------------ | :----------------------------------------------------------------------------- | :--------------------------------------------------------------------------------------------- | :-------------------------------------------------------------------------------------------- | :-------- |
| MON-RPT-004 | `getProfessorReport_Success`      | Verifica la obtención exitosa del reporte de rendimiento del profesor.    | `monitoringService.getProfessorReport` devuelve `List<ReportDTO>` válida.      | 1. Definir `idProfessor`. 2. Configurar Mock. 3. Realizar petición GET.         | Status HTTP 200 (OK). Cuerpo JSON es un array con los datos del DTO esperados.             | Comentado |
| MON-RPT-005 | `getProfessorReport_ServiceError` | Verifica el manejo de un error genérico/inesperado desde el servicio.   | `monitoringService.getProfessorReport` lanza `RuntimeException("Error DB...")`. | 1. Definir `idProfessor`. 2. Configurar Mock para lanzar `RuntimeException`. 3. Realizar GET. | Status HTTP 500 (Internal Server Error). Cuerpo de la respuesta contiene el mensaje de la excepción. | OK        |

---

### 3. Reporte de Uso de Categorías (`/getCategoriesReport/{professorId}`)

| ID Caso  | Nombre del Test (Método)                           | Descripción                                                                                       | Precondiciones (Mocks)                                                                                                    | Pasos                                                                                                                                                 | Resultado Esperado                                                                                                                                                                 | Estado |
| :------- | :------------------------------------------------- | :------------------------------------------------------------------------------------------------ | :------------------------------------------------------------------------------------------------------------------------ | :---------------------------------------------------------------------------------------------------------------------------------------------------- | :--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :----- |
| MON-RPT-006 | `getCategoriesReport_Success_WithMonitoringId`   | Verifica obtención exitosa del reporte de categorías filtrado por monitoría.                        | `monitoringService.getCategoryReport(profId, Optional.of(monId))` devuelve `Map<String, Object>` válido (estructura compleja). | 1. Definir `profId`, `monId`. 2. Configurar Mock. 3. Realizar GET con `monitoringId` como RequestParam.                                            | Status HTTP 200 (OK). Cuerpo JSON contiene la estructura compleja esperada (`detalle_por_curso`, `totales_por_categoria`).                                                              | OK     |
| MON-RPT-007 | `getCategoriesReport_Success_WithoutMonitoringId`| Verifica obtención exitosa del reporte de categorías para todas las monitorías del profesor.       | `monitoringService.getCategoryReport(profId, Optional.empty())` devuelve `Map<String, Object>` válido (estructura compleja). | 1. Definir `profId`. 2. Configurar Mock. 3. Realizar GET sin `monitoringId` como RequestParam.                                                        | Status HTTP 200 (OK). Cuerpo JSON contiene la estructura compleja esperada.                                                                                                      | OK     |
| MON-RPT-008 | `getCategoriesReport_Empty`                      | Verifica el manejo cuando el servicio devuelve un reporte vacío (listas internas vacías).          | `monitoringService.getCategoryReport` devuelve `Map` con listas vacías.                                                   | 1. Definir `profId`. 2. Configurar Mock para devolver reporte vacío. 3. Realizar GET.                                                                | Status HTTP 200 (OK). Cuerpo JSON contiene la estructura esperada con arrays `detalle_por_curso` y `totales_por_categoria` vacíos.                                                    | OK     |
| MON-RPT-009 | `getCategoriesReport_ProfessorNotFound`          | Verifica manejo cuando el profesor no existe (excepción "no encontrado").                          | `monitoringService.getCategoryReport` lanza `Exception("... no encontrado.")`.                                            | 1. Definir `profId`. 2. Configurar Mock para lanzar excepción. 3. Realizar GET.                                                                    | Status HTTP 404 (Not Found). Cuerpo JSON contiene el objeto `{"error": "..."}` con el mensaje específico.                                                                         | OK     |
| MON-RPT-010 | `getCategoriesReport_InternalError`              | Verifica manejo de error interno inesperado en el servicio.                                         | `monitoringService.getCategoryReport` lanza `RuntimeException`.                                                           | 1. Definir `profId`. 2. Configurar Mock para lanzar `RuntimeException`. 3. Realizar GET.                                                            | Status HTTP 500 (Internal Server Error). Cuerpo JSON contiene el objeto `{"error": "Error interno..."}` con el mensaje genérico del controlador.                                      | OK     |
| MON-RPT-011 | N/A                                              | Verifica manejo cuando la monitoría especificada no pertenece al profesor (si aplica validación). | `monitoringService.getCategoryReport` lanza `Exception("... no pertenece...")`.                                           | 1. Definir `profId`, `monId`. 2. Configurar Mock para lanzar excepción "no pertenece". 3. Realizar GET con `monitoringId` como RequestParam. | Status HTTP 404 (Not Found) o 403 (Forbidden), según la implementación del controlador. Cuerpo JSON contiene el objeto `{"error": "..."}` con el mensaje específico.                 | Pendiente |

---

### 4. Reporte de Asistencia Mensual (`/getAttendanceReport/{professorId}`)

| ID Caso  | Nombre del Test (Método)                                | Descripción                                                                                      | Precondiciones (Mocks)                                                                                                         | Pasos                                                                                                                                          | Resultado Esperado                                                                                                                                                                                          | Estado |
| :------- | :------------------------------------------------------ | :----------------------------------------------------------------------------------------------- | :----------------------------------------------------------------------------------------------------------------------------- | :--------------------------------------------------------------------------------------------------------------------------------------------- | :---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :----- |
| MON-RPT-012 | `getProfessorMonthlyAttendance_Success_WithoutMonitoringId` | Verifica obtención exitosa del reporte de asistencia para todas las monitorías del profesor. | `monitoringService.getMonthlyAttendanceReport(profId, Optional.empty())` devuelve `List<Map<String, Object>>` válida.           | 1. Definir `profId`. 2. Configurar Mock. 3. Realizar GET sin `monitoringId`.                                                                   | Status HTTP 200 (OK). Cuerpo JSON contiene el array de mapas esperado.                                                                                                                                    | OK     |
| MON-RPT-013 | `getProfessorMonthlyAttendance_Success_WithMonitoringId`    | Verifica obtención exitosa del reporte de asistencia filtrado por monitoría.                   | `monitoringService.getMonthlyAttendanceReport(profId, Optional.of(monId))` devuelve `List<Map<String, Object>>` válida.        | 1. Definir `profId`, `monId`. 2. Configurar Mock. 3. Realizar GET con `monitoringId` como RequestParam.                                     | Status HTTP 200 (OK). Cuerpo JSON contiene el array de mapas esperado para esa monitoría.                                                                                                                  | OK     |
| MON-RPT-014 | `getProfessorMonthlyAttendance_Empty`                   | Verifica el manejo cuando el servicio devuelve una lista vacía (sin datos de asistencia).        | `monitoringService.getMonthlyAttendanceReport` devuelve `Collections.emptyList()`.                                             | 1. Definir `profId`. 2. Configurar Mock para devolver lista vacía. 3. Realizar GET.                                                             | Status HTTP 200 (OK). Cuerpo JSON contiene el objeto `{"message": "No se encontraron datos...", "data": []}` específico definido en el controlador.                                                      | OK     |
| MON-RPT-015 | `getProfessorMonthlyAttendance_NotFound`                | Verifica manejo cuando profesor o monitoría no existen (excepción "no encontrado").            | `monitoringService.getMonthlyAttendanceReport` lanza `Exception("... no encontrado.")`.                                         | 1. Definir `profId`, `monId`. 2. Configurar Mock para lanzar excepción. 3. Realizar GET con `monitoringId` (o sin él si es el profesor). | Status HTTP 404 (Not Found). Cuerpo JSON contiene el objeto `{"error": "..."}` con el mensaje específico.                                                                                                | Comentado |
| MON-RPT-016 | `getProfessorMonthlyAttendance_InternalError`           | Verifica manejo de error interno inesperado en el servicio.                                      | `monitoringService.getMonthlyAttendanceReport` lanza `RuntimeException`.                                                       | 1. Definir `profId`. 2. Configurar Mock para lanzar `RuntimeException`. 3. Realizar GET.                                                        | Status HTTP 500 (Internal Server Error). Cuerpo JSON contiene el objeto `{"error": "Error al generar el reporte..."}` con el mensaje formateado del controlador (incluyendo el mensaje de la excepción original). | OK     |

---

**Notas:**

*   Los tests comentados (`getMonitorsReport_Success`, `getProfessorReport_Success`, `getProfessorMonthlyAttendance_NotFound`) deberían ser descomentados y verificados.
*   Se utiliza `@WebMvcTest(MonitoringController.class)` para mantener el enfoque en el controlador.
*   Los mocks de servicio se configuran para simular diversos escenarios, incluyendo retornos exitosos y excepciones.
*   Se utilizan `jsonPath` y `content().string()` para validar las respuestas. `eq()` y `any()` de Mockito se usan para especificar los argumentos esperados en las llamadas a los mocks.
*   Se cubren los casos con y sin el parámetro opcional `monitoringId` para los endpoints correspondientes.

Este diseño proporciona una buena cobertura para los endpoints de reporte implementados en `MonitoringControllerReportTest`.