# Diseño de Pruebas: AttendanceServiceImpl

Este documento detalla los casos de prueba para la clase `AttendanceServiceImpl`, responsable de la lógica de negocio relacionada con los registros de asistencia (`Attendance`). Las pruebas unitarias asociadas se encuentran en `AttendanceServiceImplTest`.

**Objetivo:** Validar que `AttendanceServiceImpl` gestiona correctamente la creación, búsqueda, actualización y eliminación de registros de asistencia, manejando las dependencias con `Activity` y `Student`, y los casos de error esperados.

**Alcance:** Pruebas unitarias de los métodos públicos de `AttendanceServiceImpl`, utilizando Mocks para las dependencias (`AttendanceRepository`, `ActivityRepository`, `StudentRepository`).

**Estrategia:** Pruebas de caja blanca y negra para cubrir los flujos principales y los casos límite. Se emplean aserciones para validar los resultados y la gestión de excepciones.

## Casos de Prueba

### 1. Creación de Asistencia (`save`)

| ID Caso | Nombre del Test (Método)   | Descripción                                                                 | Precondiciones (Mocks)                                                                                                  | Pasos                                                                                                        | Resultado Esperado                                                                                                                                      | Estado |
| :------ | :------------------------- | :-------------------------------------------------------------------------- | :---------------------------------------------------------------------------------------------------------------------- | :----------------------------------------------------------------------------------------------------------- | :------------------------------------------------------------------------------------------------------------------------------------------------------ | :----- |
| ATT-001 | `testSave_Success`         | Verifica la creación exitosa de un registro de asistencia válido.           | `activityRepository.findById` devuelve `Optional.of(activity)`. `studentRepository.findById` devuelve `Optional.of(student)`. `attendanceRepository.save` devuelve el `Attendance` guardado. | 1. Crear `Attendance` con `Activity` y `Student` válidos. 2. Configurar Mocks. 3. Llamar a `attendanceService.save(attendance)`. | Se devuelve el objeto `Attendance` guardado, no nulo. Se verifica que `attendanceRepository.save` fue llamado una vez.                                  | OK     |
| ATT-002 | `testSave_ActivityNotFound`| Verifica que se lanza una excepción si la Actividad asociada no existe.     | `activityRepository.findById` devuelve `Optional.empty()`.                                                              | 1. Crear `Attendance`. 2. Configurar Mock `activityRepository`. 3. Llamar a `attendanceService.save(attendance)`.      | Se lanza `RuntimeException` con mensaje "Actividad no encontrada...". `attendanceRepository.save` no se llama.                                       | OK     |
| ATT-003 | `testSave_StudentNotFound` | Verifica que se lanza una excepción si el Estudiante asociado no existe.    | `activityRepository.findById` devuelve `Optional.of(activity)`. `studentRepository.findById` devuelve `Optional.empty()`. | 1. Crear `Attendance`. 2. Configurar Mocks. 3. Llamar a `attendanceService.save(attendance)`.                   | Se lanza `RuntimeException` con mensaje "Estudiante no encontrado...". `attendanceRepository.save` no se llama.                                      | OK     |
| ATT-004 | N/A                        | Verifica el comportamiento si se intenta guardar `null`.                    | -                                                                                                                       | 1. Llamar a `attendanceService.save(null)`.                                                                  | Se lanza `NullPointerException` u otra excepción apropiada indicando argumento inválido.                                                                | Pendiente |
| ATT-005 | N/A                        | Verifica el comportamiento si `attendance.getActivity()` o `getStudent()` es `null`. | -                                                                                                                       | 1. Crear `Attendance` con `Activity` o `Student` nulos. 2. Llamar a `attendanceService.save(attendance)`.   | Se lanza excepción apropiada (ej. `IllegalArgumentException`) o se maneja según la lógica definida (podría fallar en `findById` si IDs son nulos). | Pendiente |

---

### 2. Búsqueda de Asistencia

| ID Caso | Nombre del Test (Método)              | Descripción                                                                      | Precondiciones (Mocks)                                                              | Pasos                                                                             | Resultado Esperado                                                                                                | Estado |
| :------ | :------------------------------------ | :------------------------------------------------------------------------------- | :---------------------------------------------------------------------------------- | :-------------------------------------------------------------------------------- | :---------------------------------------------------------------------------------------------------------------- | :----- |
| ATT-006 | `testFindByActivity`                  | Verifica la búsqueda de todas las asistencias para una actividad específica.       | `attendanceRepository.findByActivityId` devuelve `List<Attendance>`.                  | 1. Definir `activityId`. 2. Configurar Mock. 3. Llamar a `attendanceService.findByActivity(activityId)`. | Devuelve la `List<Attendance>` esperada. Se verifica llamada a `findByActivityId`.                                | OK     |
| ATT-007 | `testFindByActivity_Empty`            | Verifica la búsqueda cuando no hay asistencias para esa actividad.               | `attendanceRepository.findByActivityId` devuelve `Collections.emptyList()`.         | 1. Definir `activityId`. 2. Configurar Mock. 3. Llamar a `attendanceService.findByActivity(activityId)`. | Devuelve una lista vacía.                                                                                         | Pendiente |
| ATT-008 | `testFindByActivityAndStudent_Found`  | Verifica la búsqueda de una asistencia específica por actividad y estudiante (existente). | `attendanceRepository.findByActivityIdAndStudentCode` devuelve `Optional.of(attendance)`. | 1. Definir `activityId`, `studentId`. 2. Configurar Mock. 3. Llamar a `findByActivityAndStudent`. | Devuelve `Optional` conteniendo el `Attendance` correcto.                                                         | OK     |
| ATT-009 | `testFindByActivityAndStudent_NotFound`| Verifica la búsqueda de una asistencia específica por actividad y estudiante (no existente). | `attendanceRepository.findByActivityIdAndStudentCode` devuelve `Optional.empty()`.  | 1. Definir `activityId`, `studentId`. 2. Configurar Mock. 3. Llamar a `findByActivityAndStudent`. | Devuelve `Optional.empty()`.                                                                                      | OK     |
| ATT-010 | `testFindAll`                         | Verifica que devuelve todas las asistencias existentes.                            | `attendanceRepository.findAll` devuelve `List<Attendance>`.                         | 1. Configurar Mock. 2. Llamar a `attendanceService.findAll()`.                     | Devuelve la `List<Attendance>` esperada. Se verifica llamada a `findAll`.                                         | OK     |
| ATT-011 | `testFindAll_Empty`                   | Verifica que devuelve lista vacía si no hay asistencias.                         | `attendanceRepository.findAll` devuelve `Collections.emptyList()`.                  | 1. Configurar Mock. 2. Llamar a `attendanceService.findAll()`.                     | Devuelve una lista vacía.                                                                                         | Pendiente |
| ATT-012 | `testFindById_Found`                  | Verifica la búsqueda por ID de asistencia (existente).                         | `attendanceRepository.findById` devuelve `Optional.of(attendance)`.                 | 1. Definir `attendanceId`. 2. Configurar Mock. 3. Llamar a `attendanceService.findById(attendanceId)`. | Devuelve `Optional` conteniendo el `Attendance` correcto.                                                         | OK     |
| ATT-013 | `testFindById_NotFound`               | Verifica la búsqueda por ID de asistencia (no existente).                      | `attendanceRepository.findById` devuelve `Optional.empty()`.                        | 1. Definir `attendanceId`. 2. Configurar Mock. 3. Llamar a `attendanceService.findById(attendanceId)`. | Devuelve `Optional.empty()`.                                                                                      | OK     |

---

### 3. Actualización de Asistencia (`update`)

| ID Caso | Nombre del Test (Método) | Descripción                                                                    | Precondiciones (Mocks)                                                  | Pasos                                                               | Resultado Esperado                                                                                                             | Estado |
| :------ | :----------------------- | :----------------------------------------------------------------------------- | :---------------------------------------------------------------------- | :------------------------------------------------------------------ | :----------------------------------------------------------------------------------------------------------------------------- | :----- |
| ATT-014 | `testUpdate`             | Verifica que la actualización llama al método save del repositorio.            | `attendanceRepository.save` devuelve el objeto `Attendance` actualizado. | 1. Crear `Attendance` a actualizar. 2. Configurar Mock. 3. Llamar a `attendanceService.update(attendance)`. | Devuelve el `Attendance` actualizado. Se verifica que `attendanceRepository.save` fue llamado una vez con el objeto correcto. | OK     |
| ATT-015 | N/A                      | Verifica el comportamiento si se intenta actualizar `null`.                     | -                                                                       | 1. Llamar a `attendanceService.update(null)`.                     | Lanza `NullPointerException` o similar.                                                                                        | Pendiente |
| ATT-016 | N/A                      | Verifica si hay validaciones antes de actualizar (ej. ¿se permite cambiar ID?). | -                                                                       | 1. Crear `Attendance` con datos inválidos para update. 2. Llamar a `update`. | Lanza excepción o el comportamiento esperado según las reglas de negocio.                                                     | Pendiente |

---

### 4. Eliminación de Asistencia (`delete`, `deleteById`)

| ID Caso | Nombre del Test (Método) | Descripción                                                               | Precondiciones (Mocks)                                                                | Pasos                                                               | Resultado Esperado                                                               | Estado |
| :------ | :----------------------- | :------------------------------------------------------------------------ | :------------------------------------------------------------------------------------ | :------------------------------------------------------------------ | :------------------------------------------------------------------------------- | :----- |
| ATT-017 | `testDelete`             | Verifica que se llama al método delete del repositorio con el objeto.     | `doNothing().when(attendanceRepository).delete(any(Attendance.class))` (si es void) | 1. Crear `Attendance` a eliminar. 2. Configurar Mock. 3. Llamar a `attendanceService.delete(attendance)`. | Se verifica que `attendanceRepository.delete` fue llamado una vez con el objeto. | OK     |
| ATT-018 | `testDeleteById`         | Verifica que se llama al método deleteById del repositorio con el ID.     | `doNothing().when(attendanceRepository).deleteById(anyInt())` (si es void)            | 1. Definir `attendanceId`. 2. Configurar Mock. 3. Llamar a `attendanceService.deleteById(attendanceId)`. | Se verifica que `attendanceRepository.deleteById` fue llamado una vez con el ID. | OK     |
| ATT-019 | N/A                      | Verifica el comportamiento al intentar eliminar `null`.                   | -                                                                                     | 1. Llamar a `attendanceService.delete(null)`.                     | Lanza `NullPointerException` o similar.                                          | Pendiente |
| ATT-020 | N/A                      | Verifica si hay pre-validaciones antes de eliminar (ej. `existsById`).    | `when(attendanceRepository.existsById(id)).thenReturn(false)`                         | 1. Llamar a `attendanceService.deleteById(id)`.                   | Lanza excepción si se espera que exista, o simplemente llama a `deleteById` si no. | Pendiente |

---

### 5. Conteo (`count`)

| ID Caso | Nombre del Test (Método) | Descripción                                                         | Precondiciones (Mocks)               | Pasos                                      | Resultado Esperado                                          | Estado |
| :------ | :----------------------- | :------------------------------------------------------------------ | :----------------------------------- | :----------------------------------------- | :---------------------------------------------------------- | :----- |
| ATT-021 | `testCount`              | Verifica que devuelve el conteo proporcionado por el repositorio. | `when(attendanceRepository.count()).thenReturn(5L)` | 1. Configurar Mock. 2. Llamar a `count()`. | Devuelve `5L`. Se verifica llamada a `repository.count()`. | OK     |

---

**Notas:**

*   Los casos marcados como "Pendiente" sugieren pruebas adicionales que podrían añadirse para aumentar la cobertura y robustez.
*   El estado "OK" indica que el test existe en `AttendanceServiceImplTest` y cubre el escenario descrito.